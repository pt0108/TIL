> ë¶€íŠ¸ìº í”„ 4ì£¼ì°¨ 2022ë…„ 11ì›” 08ì¼

# 11/08 SQL (7)

- **UPDATE**
    
    Updateë¬¸ìœ¼ë¡œ ë°ì´í„° ì…ë ¥í•˜ê¸°
    
    emp_update1 í…Œì´ë¸”ì„ ìƒì„± (emp_testë¡œë¶€í„° ë³µì‚¬)
    primary key ì§€ì •
    
    ```sql
    create table emp_update1
    select * from emp_test;
    
    select * from emp_update1;
    desc emp_update1; -- primary keyê¹Œì§€ ê°€ì ¸ì˜¤ì§„ ëª»í•¨ 
    desc emp_test;
    
    -- alter : ê¸°ì¡´ ê°ì²´ë¥¼ ìˆ˜ì •í•  ë•Œ ì‚¬ìš©
    alter table emp_update1
    	add constraint primary key (emp_no);
    ```
    
    ```sql
    create table emp_update2
    select * from emp_test2;
    
    alter table emp_update2
    	add constraint primary key (emp_no);
    ```
    
    - **ë‹¨ì¼ í…Œì´ë¸” ë°ì´í„° ìˆ˜ì •í•˜ê¸°**
        
        ```sql
        update emp_update1
        	set emp_name = concat(emp_name, '2'),
        		salary = salary + 100;
        ```
        
        ì˜¤ë¥˜ ì˜ˆì‹œ : pk ì¤‘ë³µ ì…ë ¥ 
        
        ```sql
        update emp_update1
        	set emp_no = emp_no + 1
            where emp_no >= 1018;
        
        -- ë’¤ì—ë¶€í„° ìˆ˜ì • (íŠ¸ë¦­)
        -- ì£¼ì˜ : ê·¸ëŸ¬ë‚˜ primary keyëŠ” í…Œì´ë¸”ì˜ ì¤‘ìš”í•œ ì •ë³´ì´ë¯€ë¡œ ìˆ˜ì •í•˜ì§€ ë§ì! 
        update emp_update1
        	set emp_no = emp_no + 1
            where emp_no >= 1018
            order by emp_no desc;
        ```
        
    - **ë‹¤ì¤‘ í…Œì´ë¸” ë°ì´í„° ìˆ˜ì •í•˜ê¸°**
        
        ë‘ í…Œì´ë¸”ê°„ ê´€ê³„ë¥¼ ì´ìš©í•´ì„œ ì—…ë°ì´íŠ¸
        í•œ í…Œì´ë¸”(a)ì˜ ì»¬ëŸ¼ê°’ì„ ì°¸ì¡°í•´ì„œ ë‹¤ë¥¸ í…Œì´ë¸”(b)ì˜ ì»¬ëŸ¼ê°’ì„ ë³€ê²½
        
        ```sql
        update emp_update1 a, emp_update2 b
        	set a.salary = b.salary + 1000
            where a.emp_no = b.emp_no;
        ```
        
        nullê°’ìœ¼ë¡œ ì¸í•´ ì—°ì‚°ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ì„ ë•ŒëŠ” 0ìœ¼ë¡œ ë°”ê¾¼ë’¤ ë‹¤ì‹œ ì‹œë„
        
        ```sql
        update emp_update1 a, emp_update2 b
        	set a.salary = ifnull(a.salary, 0),
        		b.salary = a.salary + 2000
        	where a.emp_no = b.emp_no;
        
        update emp_update1 a, emp_update2 b
        	set	b.salary = a.salary + 2000
        	where a.emp_no = b.emp_no; -- ë‚˜ëˆ ì„œ ì‹¤í–‰
        ```
        
    - **on duplicate key - ì…ë ¥ê³¼ ìˆ˜ì • ë™ì‹œì— ì‹¤í–‰í•˜ê¸°**
        
        emp_update2 í…Œì´ë¸”ì— pkê°€ 1003, 1004, 1005ë²ˆì¸ ë°ì´í„°ë¥¼ ì…ë ¥
        ìˆ˜ì •/ì…ë ¥í•  ë°ì´í„°ëŠ” emp_name ì»¬ëŸ¼
        1003, 1004ë²ˆì€ ìˆ˜ì •, 1005ë²ˆ ì…ë ¥
        
        ```sql
        insert into emp_update2
        select * from emp_update1 a
        	where emp_no between 1003 and 1005
            on duplicate key update emp_name = a.emp_name,
        							salary = a.salary;
        ```
        
    
    ***ğŸ–Workshop***
    
    emp_update2 í…Œì´ë¸”ì—ì„œ ì‚¬ë²ˆì´ 1001ê³¼ 1002ì¸ ì‚¬ì›ëª…ì„
    emp_update1 í…Œì´ë¸”ì˜ ë™ì¼ ì‚¬ë²ˆì„ ê°€ì§„ ì‚¬ì›ëª…ìœ¼ë¡œ emp_update2ì— ë³€ê²½í•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±
    
    ```sql
    update emp_update2 a, emp_update1 b
    	set a.emp_name = b.emp_name
        where a.emp_no = b.emp_no
        and a.emp_no in (1001, 1002);
    ```
    
    *â†’ [í…Œì´ë¸” ìˆ˜ì • ê°„ë‹¨ ì •ë¦¬](https://extbrain.tistory.com/39)*
    

- **DELETE**
    
    Deleteë¬¸ìœ¼ë¡œ ë°ì´í„° ì‚­ì œí•˜ê¸°
    
    *â†’ ì¼ë‹¨ í•„ìš”í•œ í…Œì´ë¸” ìƒì„±*
    
    ```sql
    create table emp_delete
    select * from emp_test;
    
    alter table emp_delete
    	add constraint primary key (emp_no);
    
    create table emp_delete2
    select * from emp_test2;
    
    alter table emp_delete2
    	add constraint primary key (emp_no);
    ```
    
    - **ë‹¨ì¼ í…Œì´ë¸” ì‚­ì œ**
        
        **1 )** ì¡°ê±´(where)ì„ ë„£ì–´ì„œ ì‚­ì œ
        
        ```sql
        select * from emp_delete;
        delete from emp_delete
        	where salary is null; -- salaryê°€ nullê°’ì¸ ë°ì´í„°ê°€ ì‚­ì œ
        ```
        
        **2 )** ëª¨ë‘ ì‚­ì œ
        
        ```sql
        delete from emp_delete;
        ```
        
        **3 )** order by, limitì˜ ì¡°í•© ì¶”ê°€
        
        ë‘ ëª…ì˜ ë§¥ìŠ¤ì›° ì¤‘ í•œ ëª…ë§Œ ì‚­ì œ (ë’·ë²ˆí˜¸ 1018ë²ˆë§Œ ì‚­ì œ)
        
        ```sql
        delete from emp_delete
        	where emp_name = 'ë§¥ìŠ¤ì›°'
            order by emp_no desc
            limit 1;
        ```
        
    - **ë‹¤ì¤‘ í…Œì´ë¸” ì‚­ì œ**
        
        **1 )** ì¡°ê±´(where) ì‚­ì œ
        
        ```sql
        delete a, b
        	from emp_delete a, emp_delete2 b
            where a.emp_no = b.emp_no;
        ```
        
        **2 )** using ë¬¸ë²•ìœ¼ë¡œ í…Œì´ë¸” ì‚­ì œ
        
        ```sql
        delete from b
        using emp_delete a, emp_delete2 b
        	where a.emp_no = b.emp_no;
        ```
        
    
    ***ğŸ–Workshop***
    
    **ë¬¸ì œ 1)** emp_delete í…Œì´ë¸”ì—ì„œ ì‚¬ì›ëª…ì´ ë§‰ìŠ¤í´ë‘í¬ì¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ëŠ”ë°, 
    
    ì´ë²ˆì—ëŠ” ì‚¬ë²ˆì´ ë¹ ë¥¸ 1ê±´ë§Œ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±í•˜ê¸° 
    
    (1009ë²ˆê³¼ 1019ë²ˆì˜ ë§‰ìŠ¤í´ë‘í¬ ì¤‘, 1009ë²ˆì´ ì‚­ì œë˜ì–´ì•¼ í•¨)
    
    ```sql
    delete from emp_delete
    	where emp_name = 'ë§‰ìŠ¤í´ë‘í¬' -- (ì˜¤íƒ€: ì›ë˜ëŠ” ë§‰ìŠ¤í”Œë‘í¬)
        order by emp_no
        limit 1;
    ```
    
    **ë¬¸ì œ 2)**  box_office í…Œì´ë¸”ì„ ì°¸ì¡°í•´ box_office_copy í…Œì´ë¸” ìƒì„± (create, select)
    ì´ë•Œ, box_office í…Œì´ë¸”ì—ì„œ 2019ë…„ ê°œë´‰ ì˜í™” ì¤‘ ê´€ê°ìˆ˜ê°€ 800ë§Œëª… ì´ìƒì¸ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê¸°
    
    ```sql
    create table box_office_copy
    select * from box_office
    	where year(release_date) = 2019 and audience_num >= 8000000;
    ```
    
    box_office_copy í…Œì´ë¸”ì— last_year_audi_num ì´ë¼ëŠ” int ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³ ,
    box_office í…Œì´ë¸”ì—ì„œ 2018ë…„ë„ ê°œë´‰ì˜í™”ì™€ box_office_copy(2019) í…Œì´ë¸”ì˜ ìˆœìœ„ê°€ ê°™ì€ ê±´ì— ëŒ€í•´ last_year_audi_numì— 2018ë…„ë„ì˜ ê´€ê°ìˆ˜ë¥¼ ì„¤ì •
    
    ```sql
    -- ì»¬ëŸ¼ ì¶”ê°€
    alter table box_office_copy 
    	add column last_year_audi_num int null; 
    
    -- update ì „ì— ë¯¸ë¦¬ ì¡°íšŒ    
    select a.ranks, year(a.release_date), year(b.release_date), a.audience_num 2018_audience, b.audience_num 2019_audience
    	from box_office a, box_office_copy b
        where year(a.release_date) = 2018
    	and a.ranks = b.ranks;
        
    -- update
    update box_office a, box_office_copy b
    	set b.last_year_audi_num = a.audience_num
        where year(a.release_date) = 2018
    	and a.ranks = b.ranks;
    
    -- ê²°ê³¼ ì¡°íšŒ 
    select ranks, movie_name, audience_num, last_year_audi_num from box_office_copy;
    ```
    
    **ë¬¸ì œ 3)** ì‚¬ì›ì˜ ë¶€ì„œ í• ë‹¹ ì •ë³´ê°€ ë“¤ì–´ìˆëŠ” dept_emp í…Œì´ë¸”ì—ì„œ í˜„ì¬ ì¼í•˜ê³  ìˆì§€ ì•Šì€ ì‚¬ëŒ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±
    
    ```sql
    -- í…Œì´ë¸” ìƒì„±
    create table dept_emp_test
    select * from dept_emp;
    
    -- ë°ì´í„° ì‚­ì œ 
    delete from dept_emp_test
    	where sysdate() not between from_date and to_date; 
    ```
    
    *â†’ ê¸°ì¡´ 33188ê±´ì˜ ë°ì´í„°ì—ì„œ where ì¡°ê±´ì— í•´ë‹¹ë˜ëŠ” 9053ê±´ì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ê³ , 24135ê±´ì˜ ë°ì´í„°ë§Œ ë‚¨ì•„ìˆê²Œë¨.*
    

- **íŠ¸ëœì­ì…˜ ì²˜ë¦¬**
    
    *â†’ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ íŒŒíŠ¸ëŠ” git hubì—ì„œ íŒŒì¼ì„ ê´€ë¦¬í•˜ë˜ ë°©ë²•ê³¼ ê°™ì•„ì„œ ì´í•´í•˜ê¸° ì‰¬ì›€!*
    
    ```sql
    select @@autocommit;
    ```
    
    @@autocommitì€ commitì„ ìë™ìœ¼ë¡œ í•´ì¤€ë‹¤!
    
    ```sql
    set autocommit = 0; -- ë¹„í™œì„±í™”
    set autocommit = 1; -- í™œì„±í™” 
    ```
    
    íŠ¸ëœì­ì…˜ìš© í…Œì´ë¸” ìƒì„±
    
    ```sql
    create table emp_tran1
    select * from emp_test;
    
    alter table emp_tran1
    	add constraint primary key (emp_no);
    
    create table emp_tran2
    	select * from emp_test;
    
    alter table emp_tran2
    	add constraint primary key (emp_no);
    ```
    
    **DDL(Data Definition Language)**
    íŠ¸ëœì­ì…˜ì— ì˜í–¥ì„ ë°›ì§€ ì•Šìœ¼ë¯€ë¡œ, commit/rollback ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìŒ
    
    **DML(Data Manipulation Language)**
    íŠ¸ëœì­ì…˜ì— ì˜í–¥ì„ ë°›ìœ¼ë¯€ë¡œ, commit/rollback ìœ íš¨í•¨
    
    - ìë™ì»¤ë°‹ ëª¨ë“œ ë¹„í™œì„±í™” ìƒíƒœì—ì„œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬í•˜ê¸°
        
        ```sql
        set autocommit = 0;
        select @@autocommit;
        
        -- ë°ì´í„° ì‚­ì œ
        delete from emp_tran1;
        delete from emp_tran2;
        
        -- ë°ì´í„° í™•ì¸(ë°ì´í„° ì—†ìŒ)
        select * from emp_tran1;
        select * from emp_tran2;
        
        -- ì‚­ì œ ì·¨ì†Œ
        rollback;
        
        -- ë°ì´í„° í™•ì¸(ë°ì´í„° ìˆìŒ)
        select * from emp_tran1;
        select * from emp_tran2;
        
        -- ë°ì´í„° ì‚­ì œ
        delete from emp_tran1;
        
        -- ì‚­ì œ ë°˜ì˜
        commit;
        
        -- ë°ì´í„° í™•ì¸ (emp_tran1 ë°ì´í„° ì—†ìŒ)
        select * from emp_tran1;
        select * from emp_tran2;
        
        -- ì‚­ì œ ì·¨ì†Œ
        rollback; -- commitì´ ëœ ì´í›„ì—ëŠ” ë¬´ìš©ì§€ë¬¼.
        
        -- ë°ì´í„° í™•ì¸ (ì‚­ì œ ì·¨ì†Œê°€ ë˜ì§€ëŠ” ì•ŠìŒ)
        select * from emp_tran1;
        select * from emp_tran2;
        ```
        
        â†’ commitì´ë‚˜ rollbackë¬¸ì„ ë§Œë‚˜ê²Œ ë˜ë©´ ì´ ì§€ì ê¹Œì§€ê°€ í•œ íŠ¸ëœì­ì…˜ (ì¢…ë£Œ)
        
        ```sql
        select @@autocommit;
        set autocommit = 1;
        
        -- ë°ì´í„° ì…ë ¥
        insert into emp_tran1
        select * from emp_test;
        
        select * from emp_tran1;
        
        -- ì…ë ¥ ì·¨ì†Œ
        rollback;
        
        -- ì´ë¯¸ ìë™ì»¤ë°‹ì´ í™œì„±í™”(autocommit = 1)ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— rollbackì´ ì†Œìš©ì—†ìŒ 
        select * from emp_tran1;
        ```
        
    - ìë™ì»¤ë°‹ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬í•˜ê³  ì‹¶ì„ ë•Œ
        
        **start transaction**ë¬¸ì„ ì‚¬ìš© (ì¼ì‹œì ìœ¼ë¡œ ìë™ì»¤ë°‹ì´ ë¹„í™œì„±í™”)
        commitì´ë‚˜ rollbackì„ ë§Œë‚¬ì„ ë•Œ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œ, ìë™ì»¤ë°‹ì´ í™œì„±í™”
        
        ```sql
        select @@autocommit; -- 1ë¡œ ì¡°íšŒ
        
        start transaction; -- ì¼ì‹œì ìœ¼ë¡œ ìë™ì»¤ë°‹ì´ ë¹„í™œì„±í™”ëœ ìƒíƒœ
        
        -- ë°ì´í„° ì‚­ì œ
        delete from emp_tran1
        	where emp_no >= 1006;
            
        -- ë°ì´í„° ìˆ˜ì •
        update emp_tran1
        	set salary = 0
            where salary is null;
            
        select * from emp_tran1;
        
        -- start transaction ì´í›„ì— í–ˆë˜ ì‘ì—…ë“¤(ì‚­ì œ, ìˆ˜ì •) ì·¨ì†Œ
        rollback;
        
        -- ë°ì´í„° í™•ì¸
        select * from emp_tran1;
        ```
        
    - **savepoint**ë¬¸ ì‚¬ìš©ë°©ë²•
        
        ```sql
        start transaction;
        
        -- savepoint A ì„¤ì •
        savepoint A;
        
        -- ë°ì´í„° ì‚­ì œ
        delete from emp_tran1
        	where salary is null;
            
        savepoint B;
        
        -- ë°ì´í„° ì‚­ì œ
        delete from emp_tran1
        	where emp_name = 'ë§¥ìŠ¤ì›°'
            order by emp_no
            limit 1;
            
        -- savepoint B ì´í›„ ì‘ì—… ì·¨ì†Œ
        rollback to savepoint B;
        
        select * from emp_tran1;
        
        -- ìµœì¢… ë°˜ì˜
        commit;
        
        select * from emp_tran1;
        ```
        
    
    ***ğŸ–Workshop***
    
    **ë¬¸ì œ)** ìˆ˜ë™ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬í•˜ë˜ ì¤‘ emp_tran2 í…Œì´ë¸”ì—ì„œ salary ì»¬ëŸ¼ ê°’ì´ 1000ì¸ ê±´ì„ ì‚­ì œí•˜ë ¤ê³  í–ˆëŠ”ë°, ì‹¤ìˆ˜ë¡œ 1000ì´ ì•„ë‹Œ 100ì¸ ê±´ì„ ì‚­ì œ
    ì´ë¥¼ ì‚­ì œ ì „ìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” ê³¼ì • ì‘ì„±
    
    ```sql
    start transaction;
    
    delete from emp_tran2
    	where salary = 100;
    
    select * from emp_tran2;
    
    rollback;
    
    select * from emp_tran2;
    ```
    

- **CTE, ìœˆë„ìš° í•¨ìˆ˜(1)**
    
    
    **CTE** *Common Table Expression*
    
    ê°œì„ ëœ ì„œë¸Œì¿¼ë¦¬, ê³µí†µ í…Œì´ë¸” í‘œí˜„ì‹
    
    WITHìœ¼ë¡œ ì‹œì‘ë˜ëŠ” SELECTë¬¸(WITHì ˆì´ë¼ê³ ë„ í•œë‹¤)
    
    ì„œë¸Œì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ê°œ ì„ ì–¸í•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤!
    
    ë¶€ì„œ ê´€ë¦¬ì í…Œì´ë¸”(dept_manager)ê³¼ ì‚¬ì› í…Œì´ë¸”(employees)ì„ ì¡°ì¸í•´
    í˜„ì¬ ê´€ë¦¬ìì˜ ë¶€ì„œë²ˆí˜¸, ì‚¬ë²ˆ, ì‚¬ì› ì´ë¦„ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ ì‘ì„± í›„
    ë¶€ì„œ í…Œì´ë¸”(departments)ê³¼ ìµœì¢… ì¡°ì¸í•˜ê³  ë¶€ì„œëª…ê¹Œì§€ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±í•˜ê¸°
    
    ```sql
    -- (1) ì„œë¸Œì¿¼ë¦¬ ë°©ì‹ 
    select a.dept_no, a.dept_name, manager.emp_no, concat(manager.first_name, ' ', manager.last_name) name
    	from departments a,
    ( select b.dept_no, b.emp_no, c.first_name, c.last_name
    	from dept_manager b, employees c
    	where b.emp_no = c.emp_no
        and sysdate() between b.from_date and b.to_date
    ) manager
    	where a.dept_no = manager.dept_no;
    
    -- (2) CTE ë°©ì‹
    with manager as 
    ( select b.dept_no, b.emp_no, c.first_name, c.last_name
    	from dept_manager b, employees c
    	where b.emp_no = c.emp_no
        and sysdate() between b.from_date and b.to_date
    )
    select a.dept_no, a.dept_name, b.emp_no, concat(b.first_name, ' ', b.last_name) name
    	from departments a, manager b
        where a.dept_no = b.dept_no;
    ```
    
    í˜„ì¬ ì‹œì ì„ ê¸°ì¤€ìœ¼ë¡œ ê° ë¶€ì„œì— ì†í•œ ì‚¬ì›ë“¤ì˜ ì´ ê¸‰ì—¬ì— ëŒ€í•œ ë¶€ì„œë³„ í‰ê· ì„ êµ¬í•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±
    
    ```sql
    -- (1) ì„œë¸Œì¿¼ë¦¬ ë°©ì‹
    select avg(f.dept_sum_salary) -- 9ê°œ ë¶€ì„œì— ì§€ì¶œë˜ëŠ” ì´ê¸‰ì—¬ ìì²´ì˜ í‰ê·  193044765.5556
    	from
    ( select a.dept_no, a.dept_name, sum(c.salary) dept_sum_salary, avg(c.salary)
    	from departments a, dept_emp b, salaries c
        where a.dept_no = b.dept_no
        and b.emp_no = c.emp_no
        and sysdate() between b.from_date and b.to_date
        and sysdate() between c.from_date and c.to_date
        group by a.dept_no
    ) f;
    
    -- (2) CTE ë°©ì‹ 
    with dept_info as
    ( select a.dept_no, a.dept_name, sum(c.salary) dept_sum_salary, avg(c.salary)
    	from departments a, dept_emp b, salaries c
        where a.dept_no = b.dept_no
        and b.emp_no = c.emp_no
        and sysdate() between b.from_date and b.to_date
        and sysdate() between c.from_date and c.to_date
        group by a.dept_no 
    ),
    	dept_avg as
    ( select avg(f.dept_sum_salary) dept_avg_salary -- ì„œë¡œê°€ ì„œë¡œë¥¼ ì°¸ì¡° ê°€ëŠ¥ 
    	from dept_info f
    )
    select a.dept_no, a.dept_name, a.dept_sum_salary, b.dept_avg_salary
    	from dept_info a, dept_avg b;
    ```
    
    *â†’ [MySQL 8.0 CTE í™œìš©](https://jjon.tistory.com/entry/MySQL-80-%EC%8B%A0%EA%B8%B0%EB%8A%A5-CTECommon-Table-Expression-%ED%99%9C%EC%9A%A9)*
    
    - **ìœˆë„ìš° í•¨ìˆ˜**
        
        **ìœˆë„ìš°** *window* : íŠ¹ì • ì»¬ëŸ¼ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì§€ì •í•œ ë¡œìš°ì˜ ê·¸ë£¹
        
        **ìœˆë„ìš° í•¨ìˆ˜** : ìœˆë„ìš°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì—°ì‚°í•˜ëŠ” í•¨ìˆ˜ 
        
        box_office í…Œì´ë¸”ì—ì„œ 2018ë…„ ì´í›„ ê°œë´‰ëœ ì˜í™” ì¤‘ì—ì„œ ë­í‚¹ 10ìœ„ ì•ˆì— ë“  ì˜í™”ë“¤ì˜
        "ì—°ë„ë³„" ì´ ë§¤ì¶œì•¡ê³¼ í‰ê·  ë§¤ì¶œì•¡ì„ êµ¬í•˜ë˜,
        ì§‘ê³„ë˜ê¸° ì „ì˜ ê°œë³„ ì˜í™”ì´ë¦„, ë­í‚¹, ë§¤ì¶œì•¡ë„ í•¨ê»˜ í‘œì‹œí•˜ê¸°
        
        **1 )** CTE ì‚¬ìš©
        
        ```sql
        with summary as
        (
        select year(release_date) release_year, sum(sale_amt) sum_amt, avg(sale_amt) avg_amt
        	from box_office
            where year(release_date) >= 2018
            and ranks <= 10
            group by year(release_date)
        )
        select year(a.release_date), a.movie_name, a.ranks, a.sale_amt, b.sum_amt, b.avg_amt
        	from box_office a
            inner join summary b
        		on year(a.release_date) = b.release_year
        	where a.ranks <= 10
            order by 1, 3;
        ```
        
        **2 )** ìœˆë„ìš° í•¨ìˆ˜ ì‚¬ìš©
        
        ```sql
        select year(release_date) year, movie_name, ranks, sale_amt,
        	sum(sale_amt) over (partition by year(release_date)) sum_amt,
            avg(sale_amt) over (partition by year(release_date)) avg_amt
        	from box_office
            where year(release_date) >= 2018
            and ranks <= 10;
        ```
        
        1ìœ„ì¸ ì˜í™”ë“¤ì˜ í‰ê·  ë§¤ì¶œì•¡ê³¼ ê°œë³„ ì˜í™”ì´ë¦„, ë­í‚¹, ë§¤ì¶œì•¡ ì¡°íšŒí•˜ê¸°
        
        **1 )** CTE ë°©ì‹
        
        ```sql
        with avg_first as
        (
        select avg(sale_amt) avg_amt
          from box_office
         where ranks = 1
        )
        select year(a.release_date), a.ranks, a.movie_name, a.sale_amt, b.avg_amt
          from box_office a, avg_first b
         where a.ranks = 1
           -- and a.sale_amt > b.avg_amt
         order by 1;
        ```
        
        **2 )** ìœˆë„ìš° í•¨ìˆ˜
        
        ```sql
        select year(release_date), ranks, movie_name, sale_amt,
          avg(sale_amt) over(partition by ranks) avg_amt
          from box_office
         where ranks = 1;
        ```
        
        *ì°¸ê³  : window í•¨ìˆ˜ì—ëŠ” í‰ê·  ë§¤ì¶œë³´ë‹¤ í° ì¡°ê±´ì´ ì•ˆë“¤ì–´ê°€ì„œ ì•„ë˜ì™€ê°™ì´ cte ì‚¬ìš©í•˜ì—¬ í•´ê²°!*
        
        ```sql
        with avg_info as
         (
         select year(release_date), ranks, movie_name, sale_amt,
          avg(sale_amt) over(partition by ranks) avg_amt
          from box_office
         where ranks = 1
         )
         select year(a.release_date), a.ranks, a.movie_name, a.sale_amt, b.avg_amt
          from box_office a, avg_info b
           where a.ranks = b.ranks	
             and a.sale_amt = b.sale_amt
             and a.sale_amt > b.avg_amt;
        ```
        
        *â†’ [MySQL ìœˆë„ìš° í•¨ìˆ˜](https://mizykk.tistory.com/121)*
