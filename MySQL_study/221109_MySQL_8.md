> ë¶€íŠ¸ìº í”„ 4ì£¼ì°¨ 2022ë…„ 11ì›” 09ì¼

- **ìœˆë„ìš° í•¨ìˆ˜(2)**
    
    
    - **ë¶€ì„œë³„ salary í•©ê³„**
        
        ```sql
        select employee_id, emp_name, manager_id, salary, dept_name,
        	sum(salary) over(partition by dept_name) sum_salary
        	from emp_hierarchy;
        ```
        
        ìœˆë„ìš° ë‚´ì—ì„œ ì •ë ¬í•  ì»¬ëŸ¼ì„ order by ë’¤ì— ì§€ì •í•  ìˆ˜ ìˆë‹¤.
        ê·¸ëŸ¬ë‚˜ oder by ë’¤ì— ê¸°ë³¸ê°’ìœ¼ë¡œ í”„ë ˆì„ì˜ ë²”ìœ„ê°€ ì§€ì •ë˜ì–´ ìˆëŠ”ë°,
        order byê°€ ì§€ì •ë˜ì–´ ìˆì„ ë•Œì™€ order byê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ì„ë•Œ ì°¨ì´ê°€ ìˆë‹¤.
        
        order byê°€ ì§€ì •ë˜ì–´ ìˆì„ ê²½ìš°ì—ëŠ”,
        í”„ë ˆì„ ì ˆì˜ ê¸°ë³¸ê°’ì€ range between unbounded preceding and current row ì´ë©°
        ê·¸ëŸ° ì´ìœ ë¡œ sum_salaryê°€ ìœ„ì— order byë¥¼ ì§€ì •í•˜ì§€ ì•Šì•˜ì„ ë•Œì™€ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ í‘œì‹œê°€ ëœë‹¤.
        
        ```sql
        select employee_id, emp_name, manager_id, salary, dept_name,
          sum(salary) over (partition by dept_name order by salary) sum_salary
          from emp_hierarchy;
        ```
        
        í•´ë‹¹ íŒŒí‹°ì…˜ ì•ˆì—ì„œ sum ê°’ì´ ë™ì¼í•˜ê²Œ ì§€ì •ë˜ê²Œ í•˜ê³ ì í•œë‹¤ë©´
        rows between unbounded preceding and unbounded following ì™€ ê°™ì´ ê¸°ë³¸ê°’ì„ ë³€ê²½!
        
        ```sql
        select employee_id, emp_name, manager_id, salary, dept_name,
          sum(salary) over (partition by dept_name order by salary rows between unbounded preceding and unbounded following) sum_salary
          from emp_hierarchy;
        ```
        
        - **row_number() :** ë¡œìš°ì˜ ìˆœë²ˆ
            
            ```sql
            select employee_id, emp_name, manager_id, salary, dept_name,
            row_number() over(partition by dept_name order by salary desc) sum_salary
            	from emp_hierarchy;
            ```
            
        - **rank() :** ìˆœìœ„
        **dense_rank() :** ëˆ„ì  ìˆœìœ„
        **percent_rank() :** ë¹„ìœ¨ ìˆœìœ„ (rank()-1)/(row-1) ìƒìœ„ ëª‡ í¼ì„¼íŠ¸ì¸ê°€
            
            ```sql
            select employee_id, emp_name, manager_id, salary, dept_name,
            	rank() over(partition by dept_name order by salary desc) ranks,
            	dense_rank() over(partition by dept_name order by salary desc) dense_ranks,
            	percent_rank() over(partition by dept_name order by salary desc) percent_ranks
            	from emp_hierarchy;
            ```
            
        - **lag(ì»¬ëŸ¼ëª…) :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°”ë¡œ ì• ë¡œìš°ì˜ ì»¬ëŸ¼ì„ ê°€ì ¸ì˜¤ê¸°
            
            *= lag(ì»¬ëŸ¼ëª…, 1, null)* 
            **lead(ì»¬ëŸ¼ëª…) :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°”ë¡œ ë’¤ ë¡œìš°ì˜ ì»¬ëŸ¼ì„ ê°€ì ¸ì˜¤ê¸°
            
            *= lead(ì»¬ëŸ¼ëª…, 1, null)*
            
            ```sql
            select employee_id, emp_name, manager_id, salary, dept_name,
            	lag(salary) over(partition by dept_name order by salary desc) lag_ ,
                lead(salary) over(partition by dept_name order by salary desc) lead_
                from emp_hierarchy;
            ```
            
        - **lag(ì»¬ëŸ¼ëª…, n, 'ê°’') :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ní–‰ ì• ë¡œìš°ì˜ ì»¬ëŸ¼ê°’ì„ ê°€ì ¸ì˜¤ê¸°
        **lead(ì»¬ëŸ¼ëª…, n, 'ê°’') :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ní–‰ ë’¤ ë¡œìš°ì˜ ì»¬ëŸ¼ê°’ì„ ê°€ì ¸ì˜¤ê¸°
            
            ```sql
            select employee_id, emp_name, manager_id, salary, dept_name,
            	lag(salary, 2, 0) over(partition by dept_name order by salary desc) lag_ ,
                lead(salary, 2, 0) over(partition by dept_name order by salary desc) lead_
                from emp_hierarchy;
            ```
            
    
    ***ğŸ–Workshop***
    
    **ë¬¸ì œ1)** box_office í…Œì´ë¸”ì—ì„œ 
    
    í•´ë§ˆë‹¤ 1ìœ„ì˜€ë˜ ì˜í™”ë“¤ì— ëŒ€í•´ ì „ë…„ë„ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒë…„ë„ ë§¤ì¶œì˜ ì¦ê°ì„ êµ¬í•˜ê¸°
    
    ```sql
    -- (1) ë¨¼ì € box_office í…Œì´ë¸”ì—ì„œ í•´ë§ˆë‹¤ 1ìœ„ì˜€ë˜ ì˜í™”ë“¤ì˜ ì—°ë„ì™€ ë§¤ì¶œ êµ¬í•˜ê¸°
    select year(release_date), ranks, movie_name, sale_amt
      from box_office
     where ranks = 1
     order by 1;
    
    -- (2) ë§¤ì¶œ ì¦ê°ìœ¨ì„ ì•Œê¸° ìœ„í•´ì„œëŠ” ì „ë…„ ë§¤ì¶œì´ í•„ìš”, lag() í•¨ìˆ˜ ì´ìš©
    select year(release_date) release_year, ranks, movie_name, sale_amt curr_year_sale_amt,
      lag(sale_amt) over (order by year(release_date)) last_year_sale_amt
      from box_office
     where ranks = 1
     order by 1;
    
    -- (3) ìµœì¢…ì ìœ¼ë¡œ ë§¤ì¶œ ì¦ê°ìœ¨ êµ¬í•˜ê¸°
    -- ë§¤ì¶œ ì¦ê°ìœ¨ : (ì˜¬í•´ ë§¤ì¶œ - ì „ë…„ ë§¤ì¶œ)/ì „ë…„ ë§¤ì¶œ * 100 with sale_amt_summary as 
    with sale_amt_summary as
    ( select year(release_date) release_year, ranks, movie_name, sale_amt current_year_sale_amt,
    	lag(sale_amt) over (order by year(release_date)) last_year_sale_amt
    	from box_office
        where ranks = 1
    )
    select release_year, ranks, movie_name, current_year_sale_amt, last_year_sale_amt,
    	(current_year_sale_amt - last_year_sale_amt)/last_year_sale_amt*100 as rates
    	from sale_amt_summary;
    -- > 2005ë…„ë„ ê¸°ì¤€ ì „ë…„ ëŒ€ë¹„ 1ìœ„ ë§¤ì¶œì•¡ì´ 157% ì¦ê°€
    ```
    
    **ë¬¸ì œ2)** box_office í…Œì´ë¸”ì—ì„œ 2019ë…„ ê°œë´‰ ì˜í™”ì˜ ì›”ë³„ ì´ ë§¤ì¶œì•¡ê³¼ ì „ì›” ëŒ€ë¹„ ì¦ê°ìœ¨ì„ êµ¬í•˜ëŠ” ì¿¼ë¦¬ ì‘ì„±
    
    ```sql
    -- (1) ì›”ë³„ ë§¤ì¶œ í•©
    select year(release_date) ê°œë´‰ì—°ë„, month(release_date) ì›”, sum(sale_amt) ì›”ë§¤ì¶œí•©
    	from box_office
        where year(release_date) = 2019
        group by 2
        order by 2;
    -- (2) (1)ì˜ ì¿¼ë¦¬ì— ì¶”ê°€í•˜ì—¬ ì „ì›” ë§¤ì¶œê¹Œì§€ í‘œì‹œ 
    select year(release_date) ê°œë´‰ì—°ë„, month(release_date) ì›”, sum(sale_amt) ì›”ë§¤ì¶œí•©,
    	lag(sum(sale_amt)) over (order by month(release_date)) ì „ì›”ë§¤ì¶œí•©
    	from box_office
        where year(release_date) = 2019
        group by 2
        order by 2;
    -- (3) ìµœì¢…ì ìœ¼ë¡œ ë§¤ì¶œ ì¦ê°ìœ¨ êµ¬í•˜ê¸° 
    with month_sale_amt as
    (
    select year(release_date) ê°œë´‰ì—°ë„, month(release_date) ì›”, sum(sale_amt) ì›”ë§¤ì¶œí•©,
    	lag(sum(sale_amt)) over (order by month(release_date)) ì „ì›”ë§¤ì¶œí•©
    	from box_office
        where year(release_date) = 2019
        group by month(release_date)
        order by 2
    )
    select ê°œë´‰ì—°ë„, ì›”, ì›”ë§¤ì¶œí•©, ì „ì›”ë§¤ì¶œí•©,
    round((ì›”ë§¤ì¶œí•© - ì „ì›”ë§¤ì¶œí•©)/ì „ì›”ë§¤ì¶œí•©*100, 2) ë§¤ì¶œì¦ê°ìœ¨
    from month_sale_amt;
    ```
    
    - **í”„ë ˆì„ ì ˆë¡œ ì§‘ê³„ ë²”ìœ„ ì¡°ì •í•˜ê¸°**
        
        â†’ [*ì°¸ê³ *](https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html)   
        **with order by :** RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW   
        **without order by :** RANGE BETWEEN UNBOUNDED PRECIDING AND UNBOUNDED FOLLOWING
        
        ë¶€ì„œë³„ salary í•©ê³„ êµ¬í•˜ê¸° 
        
        ```sql
        -- without order by
        select employee_id, emp_name, manager_id, salary, dept_name,
        	sum(salary) over (partition by dept_name) sum_salary
            from emp_hierarchy;
            
        -- with order by
        select employee_id, emp_name, manager_id, salary, dept_name,
        	sum(salary) over (partition by dept_name order by salary) sum_salary
            from emp_hierarchy;
        ```
        
        **rowsì™€ rangeì˜ ì°¨ì´**
        
        **rows :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¡œìš° ë‹¨ìœ„ë¡œ ëŒ€ìƒ í”„ë ˆì„ ì§€ì •
        **range :** í˜„ì¬ ë¡œìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°’ì˜ ë²”ìœ„ ë‹¨ìœ„ë¡œ ëŒ€ìƒ í”„ë ˆì„ ì§€ì •
        
        ```sql
        select employee_id, emp_name, manager_id, salary, dept_name,
        	sum(salary) over (partition by dept_name order by salary rows between unbounded preceding and current row) row_sum_salary,
            sum(salary) over (partition by dept_name order by salary range between unbounded preceding and current row) range_sum_salary
            from emp_hierarchy;
            
        select employee_id, emp_name, manager_id, salary, dept_name,
        	sum(salary) over (partition by dept_name order by salary rows between 1 preceding and 1 following) row_sum_salary,
            sum(salary) over (partition by dept_name order by salary range between 1000 preceding and 1000 following) range_sum_salary
            from emp_hierarchy;
            -- > í˜„ì¬ ê°’ì„ ê¸°ì¤€ì„ ì§€ì •ëœ ê°’ ì‚¬ì´ë¥¼ í”„ë ˆì„ìœ¼ë¡œ ì§€ì •í•œ sumê°’ì´ ë‚˜ì˜¤ëŠ” ê²ƒì„!
        ```
        
    

- **ë·°**
    
    
    ë°ì´í„°ë² ì´ìŠ¤ì— ì¡´ì¬í•˜ëŠ”Â ì¼ì¢…ì˜ ê°€ìƒ í…Œì´ë¸”ë¡œ, 
    
    ë‹¤ë¥¸ í…Œì´ë¸”ì´ë‚˜ ë‹¤ë¥¸ ë·°ì— ì €ì¥ë˜ì–´ ìˆëŠ”Â ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ì—­í• ë§Œì„ ìˆ˜í–‰í•œë‹¤.
    
    **ë·° ìƒì„±í•˜ê¸°**
    
    ```sql
    select *
    	from dept_emp
        where sysdate() between from_date and to_date;
      
    create or replace view dept_emp_v as
    select *
    	from dept_emp
        where sysdate() between from_date and to_date;
    
    select * from dept_emp_v;
    ```
    
    **ë·° ìˆ˜ì •í•˜ê¸°**
    
    ```sql
    -- option 1
    create or replace view dept_emp_v as
    select emp_no, dept_no
    	from dept_emp
        where sysdate() between from_date and to_date;
    
    -- option 2
    alter view dept_emp_v as
    select *
    	from dept_emp
        where sysdate() between from_date and to_date;
    ```
    
    **ë·° ì‚­ì œí•˜ê¸°**
    
    ```sql
    drop view dept_emp_v;
    ```
    
    **ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ë·°ë¡œ ë§Œë“¤ê¸°**
    
    ```sql
    create or replace view sale_amt_v as
    with avg_info as
    (
    	select year(release_date), ranks, movie_name, sale_amt,
        avg(sale_amt) over(partition by ranks) avg_amt
        from box_office
        where ranks = 1
    )
    select year(a.release_date), a.ranks, a.movie_name, a.sale_amt, b.avg_amt
    	from box_office a, avg_info b
        where a.ranks = b.ranks
        and a.sale_amt = b.sale_amt
        and a.sale_amt > b.avg_amt;
        
    select * 
    	from sale_amt_v
    	order by 1;
    ```
    
    â†’ [*MySQL View*](https://prinha.tistory.com/entry/MySQL-%EA%B0%80%EC%83%81%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%84-%EC%9D%98%EB%AF%B8%ED%95%98%EB%8A%94-%EB%B7%B0View%EB%A5%BC-%EC%93%B0%EB%8A%94-%EC%9D%B4%EC%9C%A0%EC%99%80-%EC%83%9D%EC%84%B1%EB%8C%80%EC%B2%B4%EC%88%98%EC%A0%95%EC%82%AD%EC%A0%9C)
    

- **covid19_exercise**
    
    *â†’ ì œê³µëœ ë°ì´í„°ë¡œ covid19_countryì™€ covid19_data í…Œì´ë¸” ìƒì„±*
    
    ```sql
    select count(*) from covid19_country; -- 215
    select count(*) from covid19_data; -- 71957
    ```
    
    - **ë°ì´í„° ì •ì œí•˜ê¸°**
        
        **(1)** ë¶ˆí•„ìš”í•œ ë°ì´í„° ì‚­ì œí•˜ê¸°
        
        covid19_countryì™€ covid19_data í…Œì´ë¸”ì—ëŠ” ëŒ€ë¥™ìš©ìœ¼ë¡œ ì§‘ê³„ëœ ì¤‘ë³µ ë°ì´í„°ê°€ ë“¤ì–´ê°€ ìˆìŠµë‹ˆë‹¤. ê° í…Œì´ë¸”ì—ì„œ êµ­ê°€ ì½”ë“œê°€ OWIDë¡œ ì‹œì‘í•˜ëŠ” ë°ì´í„°ë¥¼ í™•ì¸(select) í›„ ì‚­ì œ(delete) í•˜ì„¸ìš”.
        
        ```sql
        -- covid19_country ë°ì´í„° í™•ì¸ í›„ ì‚­ì œ
        select *
        	from covid19_country
        	where countrycode LIKE 'OWID%';
            
        delete from covid19_country
        	where countrycode LIKE 'OWID%';
            
        -- covid19_data ë°ì´í„° í™•ì¸ í›„ ì‚­ì œ
        select *
        	from covid19_data
        	where countrycode LIKE 'OWID%';
            
        delete from covid19_data
        	where countrycode LIKE 'OWID%';
        ```
        
        **(2)** ìˆ«ìí˜• ì»¬ëŸ¼ì— null ì´ ìˆëŠ” ê°’ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ ê°’ë“¤ì„ 0ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
        
        ```sql
        update covid19_country
          set population = ifnull(population, 0),
          population_density = ifnull(population_density, 0),
          median_age = ifnull(median_age, 0),
          aged_65_older = ifnull(aged_65_older, 0),
          aged_70_older = ifnull(aged_70_older, 0),
          hospital_beds_per_thousand = ifnull(hospital_beds_per_thousand, 0);
          
        update covid19_data
          set cases = ifnull(cases,0),
          new_cases_per_million = ifnull(new_cases_per_million,0),
          deaths = ifnull(deaths,0),
          icu_patients = ifnull(icu_patients,0),
          hosp_patients = ifnull(hosp_patients,0),
          tests = ifnull(tests,0),
          reproduction_rate = ifnull(reproduction_rate,0),
          new_vaccinations = ifnull(new_vaccinations,0),
          stringency_index = ifnull(stringency_index,0);
        ```
        
        â†’ ì´ë ‡ê²Œ **ifnull**ì„ ì‚¬ìš©í•´ì„œ ì „ë¶€ ì—…ë°ì´íŠ¸ì‹œì¼œì•¼ í•œë‹¤!
        
    - **ë°ì´í„° ë¶„ì„**
        
        **(1)** 2020ë…„ ì‚¬ë§ì ìˆ˜ ìƒìœ„ 10ê°œêµ­ ì¡°íšŒ
        
        ```sql
        -- option 1
        select b.countryname, sum(a.deaths) death_num, sum(a.cases) case_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         where year(a.issue_date) = 2020
         group by b.countryname
         order by 2 desc
         limit 10;
        ```
        
        ```sql
        -- option 2
        select b.countryname, sum(a.deaths) death_num, sum(a.cases) case_num,
          rank() over (order by sum(a.deaths) desc) death_rank
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         where year(a.issue_date) = 2020
         group by b.countryname
         limit 10;
        ```
        
        â†’ rank_overë¡œ ëˆ„ì  ìˆœìœ„ë„ ì§‘ê³„ë˜ê³ , ì•ˆì— order byë¡œ ì‚¬ë§ì í•©ê³„ë³„ ì •ë ¬ì´ ê°€ëŠ¥!
        
        **(2)** 2020ë…„ ì¸êµ¬ ëŒ€ë¹„ í™•ì§„ì ìˆ˜ì™€ ì‚¬ë§ì ìˆ˜ ë¹„ìœ¨ ì¡°íšŒ
        
        **1 -** 2020ë…„ ì‚¬ë§ì ìˆ˜ ìƒìœ„ 10ê°œêµ­
        
        ```sql
        select b.countryname, sum(a.deaths) death_num, sum(a.cases) case_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         where year(a.issue_date) = 2020
         group by b.countryname
         order by 2 desc
         limit 10;
        ```
        
        **2 -** ì´ ë°ì´í„°ì˜ ì¸êµ¬ëŒ€ë¹„ í™•ì§„ì ìˆ˜ ë¹„ìœ¨ ì¡°íšŒ
        
        ```sql
        select t.countryname, t.death_num, t.case_num, t.population,
           round(t.death_num/t.population * 100, 5) death_popul_rate,
           round(t.case_num/t.population * 100, 5) case_popul_rate
        from (
        select b.countryname, sum(a.deaths) death_num, sum(a.cases) case_num, b.population
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         where year(a.issue_date) = 2020
         group by b.countryname
         order by 2 desc
         limit 10
        )t
        order by 5 desc;
        ```
        
        **(3)** ìš°ë¦¬ë‚˜ë¼ì˜ ì›”ë³„ í™•ì§„ì ìˆ˜ì™€ ì‚¬ë§ì ìˆ˜ ì¡°íšŒ
        
        **1 -** ìš°ë¦¬ë‚˜ë¼ì˜ ì›”ë³„ í™•ì§„ììˆ˜ì™€ ì‚¬ë§ììˆ˜ì˜ í•©ê³„
        
        ```sql
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1
         order by 1;
        ```
        
        **2 -** 1ì—ì„œ êµ¬í•œ ì›”ë³„ í™•ì§„ììˆ˜ì™€ ì‚¬ë§ììˆ˜ì˜ ì´ê³„
        
        ```sql
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1
        union all -- union allì„ ì‚¬ìš©í•´ì„œ ì´ê³„ê°’ì„ ë°‘ì— ë§ë¶™ì„! 
        select "All", sum(cases), sum(deaths)
         from covid19_data
         where countrycode = 'kor';
        ```
        
        **3 -** 1ì—ì„œ êµ¬í•œ ê²°ê³¼ë¥¼ ì°¸ê³ í•´ì„œ "í™•ì§„ììˆ˜"ì— ëŒ€í•´ì„œë§Œ ë…„ì›”ë³„ í•©ê³„ë¥¼ ì»¬ëŸ¼ í˜•íƒœë¡œ ì¡°íšŒ
        
        ```sql
        with tmp as(
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1
        ) 
         select sum(case when months = 202001 then case_num else 0 end) "202001",
               sum(case when months = 202002 then case_num else 0 end) "202002",
               sum(case when months = 202003 then case_num else 0 end) "202003",
               sum(case when months = 202004 then case_num else 0 end) "202004",
               sum(case when months = 202005 then case_num else 0 end) "202005",
               sum(case when months = 202006 then case_num else 0 end) "202006",
               sum(case when months = 202007 then case_num else 0 end) "202007",
               sum(case when months = 202008 then case_num else 0 end) "202008",
               sum(case when months = 202009 then case_num else 0 end) "202009",
               sum(case when months = 202010 then case_num else 0 end) "202010",
               sum(case when months = 202011 then case_num else 0 end) "202011",
               sum(case when months = 202012 then case_num else 0 end) "202012",
               sum(case when months = 202101 then case_num else 0 end) "202101",
               sum(case when months = 202102 then case_num else 0 end) "202102"     
        from tmp;
        ```
        
        *â†’ ì‚¬ë§ììˆ˜ê¹Œì§€ ì¶”ê°€í•˜ë©´ ì•„ë˜ì™€ ê°™ì´*
        
        ```sql
        with tmp as(
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1
        ) 
         select "í™•ì§„" ì¢…ë¥˜, 
               sum(case when months = 202001 then case_num else 0 end) "202001",
               sum(case when months = 202002 then case_num else 0 end) "202002",
               sum(case when months = 202003 then case_num else 0 end) "202003",
               sum(case when months = 202004 then case_num else 0 end) "202004",
               sum(case when months = 202005 then case_num else 0 end) "202005",
               sum(case when months = 202006 then case_num else 0 end) "202006",
               sum(case when months = 202007 then case_num else 0 end) "202007",
               sum(case when months = 202008 then case_num else 0 end) "202008",
               sum(case when months = 202009 then case_num else 0 end) "202009",
               sum(case when months = 202010 then case_num else 0 end) "202010",
               sum(case when months = 202011 then case_num else 0 end) "202011",
               sum(case when months = 202012 then case_num else 0 end) "202012",
               sum(case when months = 202101 then case_num else 0 end) "202101",
               sum(case when months = 202102 then case_num else 0 end) "202102"     
        from tmp
        union all
         select "ì‚¬ë§" ì¢…ë¥˜, 
               sum(case when months = 202001 then death_num else 0 end) "202001",
               sum(case when months = 202002 then death_num else 0 end) "202002",
               sum(case when months = 202003 then death_num else 0 end) "202003",
               sum(case when months = 202004 then death_num else 0 end) "202004",
               sum(case when months = 202005 then death_num else 0 end) "202005",
               sum(case when months = 202006 then death_num else 0 end) "202006",
               sum(case when months = 202007 then death_num else 0 end) "202007",
               sum(case when months = 202008 then death_num else 0 end) "202008",
               sum(case when months = 202009 then death_num else 0 end) "202009",
               sum(case when months = 202010 then death_num else 0 end) "202010",
               sum(case when months = 202011 then death_num else 0 end) "202011",
               sum(case when months = 202012 then death_num else 0 end) "202012",
               sum(case when months = 202101 then death_num else 0 end) "202101",
               sum(case when months = 202102 then death_num else 0 end) "202102"     
        from tmp;
        ```
        
        **(4)** êµ­ê°€ë³„, ì›”ë³„ í™•ì§„ì ìˆ˜ì™€ ì‚¬ë§ì ìˆ˜ ì¡°íšŒ
        
        **1 -** êµ­ê°€ë³„ë¡œ í™•ì§„ìì™€ ì‚¬ë§ì‚¬ì£¼ë¥¼ ì¡°íšŒí•˜ë˜, ì›”ì„ ì»¬ëŸ¼ì— ìœ„ì¹˜
        
        ```sql
        select b.countryname, extract(year_month from a.issue_date) months, sum(a.cases) case_num, sum(a.deaths) death_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
          group by 1, 2;
        
        with tmp1 as(
        select b.countryname, extract(year_month from a.issue_date) months, sum(a.cases) case_num, sum(a.deaths) death_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
          group by 1, 2
        )
        select countryname, "1.í™•ì§„" ë¶„ë¥˜,
               sum(case when months = 202001 then case_num else 0 end) "202001",
               sum(case when months = 202002 then case_num else 0 end) "202002",
               sum(case when months = 202003 then case_num else 0 end) "202003",
               sum(case when months = 202004 then case_num else 0 end) "202004",
               sum(case when months = 202005 then case_num else 0 end) "202005",
               sum(case when months = 202006 then case_num else 0 end) "202006",
               sum(case when months = 202007 then case_num else 0 end) "202007",
               sum(case when months = 202008 then case_num else 0 end) "202008",
               sum(case when months = 202009 then case_num else 0 end) "202009",
               sum(case when months = 202010 then case_num else 0 end) "202010",
               sum(case when months = 202011 then case_num else 0 end) "202011",
               sum(case when months = 202012 then case_num else 0 end) "202012",
               sum(case when months = 202101 then case_num else 0 end) "202101",
               sum(case when months = 202102 then case_num else 0 end) "202102"    
          from tmp1
         group by 1
          union all
        select countryname, "2. ì‚¬ë§" ë¶„ë¥˜,  
               sum(case when months = 202001 then death_num else 0 end) "202001",
               sum(case when months = 202002 then death_num else 0 end) "202002",
               sum(case when months = 202003 then death_num else 0 end) "202003",
               sum(case when months = 202004 then death_num else 0 end) "202004",
               sum(case when months = 202005 then death_num else 0 end) "202005",
               sum(case when months = 202006 then death_num else 0 end) "202006",
               sum(case when months = 202007 then death_num else 0 end) "202007",
               sum(case when months = 202008 then death_num else 0 end) "202008",
               sum(case when months = 202009 then death_num else 0 end) "202009",
               sum(case when months = 202010 then death_num else 0 end) "202010",
               sum(case when months = 202011 then death_num else 0 end) "202011",
               sum(case when months = 202012 then death_num else 0 end) "202012",
               sum(case when months = 202101 then death_num else 0 end) "202101",
               sum(case when months = 202102 then death_num else 0 end) "202102"  
          from tmp1
          group by 1
          order by 1;
        ```
        
        **2 -** 1ì—ì„œ ë§Œë“  ì¿¼ë¦¬ë¥¼ ë·°ë¡œ ë§Œë“¤ì–´ ë¯¸êµ­ì˜ í˜„í™©(í™•ì§„ììˆ˜ì™€ ì‚¬ë§ììˆ˜)ì„ ì¡°íšŒ
        
        ```sql
        create or replace view covid19_summary_v as
        with tmp1 as(
        select b.countryname, extract(year_month from a.issue_date) months, sum(a.cases) case_num, sum(a.deaths) death_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
          group by 1, 2
        )
        select countryname, "1.í™•ì§„" ë¶„ë¥˜,
               sum(case when months = 202001 then case_num else 0 end) "202001",
               sum(case when months = 202002 then case_num else 0 end) "202002",
               sum(case when months = 202003 then case_num else 0 end) "202003",
               sum(case when months = 202004 then case_num else 0 end) "202004",
               sum(case when months = 202005 then case_num else 0 end) "202005",
               sum(case when months = 202006 then case_num else 0 end) "202006",
               sum(case when months = 202007 then case_num else 0 end) "202007",
               sum(case when months = 202008 then case_num else 0 end) "202008",
               sum(case when months = 202009 then case_num else 0 end) "202009",
               sum(case when months = 202010 then case_num else 0 end) "202010",
               sum(case when months = 202011 then case_num else 0 end) "202011",
               sum(case when months = 202012 then case_num else 0 end) "202012",
               sum(case when months = 202101 then case_num else 0 end) "202101",
               sum(case when months = 202102 then case_num else 0 end) "202102"    
          from tmp1
         group by 1
          union all
        select countryname, "2. ì‚¬ë§" ë¶„ë¥˜,  
               sum(case when months = 202001 then death_num else 0 end) "202001",
               sum(case when months = 202002 then death_num else 0 end) "202002",
               sum(case when months = 202003 then death_num else 0 end) "202003",
               sum(case when months = 202004 then death_num else 0 end) "202004",
               sum(case when months = 202005 then death_num else 0 end) "202005",
               sum(case when months = 202006 then death_num else 0 end) "202006",
               sum(case when months = 202007 then death_num else 0 end) "202007",
               sum(case when months = 202008 then death_num else 0 end) "202008",
               sum(case when months = 202009 then death_num else 0 end) "202009",
               sum(case when months = 202010 then death_num else 0 end) "202010",
               sum(case when months = 202011 then death_num else 0 end) "202011",
               sum(case when months = 202012 then death_num else 0 end) "202012",
               sum(case when months = 202101 then death_num else 0 end) "202101",
               sum(case when months = 202102 then death_num else 0 end) "202102"  
          from tmp1
          group by 1
          order by 1;
               
        select * from covid19_summary_v
          where countryname = 'united states';
        ```
        
        **(5)** ìš°ë¦¬ë‚˜ë¼ì˜ ì›”ë³„ ëˆ„ì  í™•ì§„ì ìˆ˜ì™€ ì‚¬ë§ì ìˆ˜ ì¡°íšŒ
        
        **1 -** ìš°ë¦¬ë‚˜ë¼ì˜ ì›”ë³„ í™•ì§„ììˆ˜ì™€ ì‚¬ë§ììˆ˜ì˜ í•©ì„ ì¡°íšŒ
        
        ```sql
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1;
        ```
        
        **2 -** ìœˆë„ìš° í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ë‚˜ë¼ì˜ ì›”ë³„ ëˆ„ì  í™•ì§„ììˆ˜ì™€ ëˆ„ì  ì‚¬ë§ììˆ˜ë¥¼ ì¡°íšŒ
        
        ```sql
        -- without cte
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num,
          sum(sum(cases)) over (order by extract(year_month from issue_date)) cum_case_num,
          sum(sum(deaths)) over (order by extract(year_month from issue_date)) death_case_num
          from covid19_data
         where countrycode = 'kor'
         group by 1;
         
         -- with cte 
        with tmp as (
        select extract(year_month from issue_date) months, sum(cases) case_num, sum(deaths) death_num
          from covid19_data
         where countrycode = 'kor'
         group by 1
        )
        select months, case_num, death_num,
          sum(case_num) over (order by months) cum_case_num,
          sum(death_num) over (order by months) death_case_num
          from tmp;
        ```
        
        **(6)** ëŒ€ë¥™ë³„ ì‚¬ë§ì ìˆ˜ ìƒìœ„ 3ê°œêµ­ ì¡°íšŒ
        
        ì „ ê¸°ê°„ì„ ëŒ€ìƒìœ¼ë¡œ ëŒ€ë¥™ë³„ë¡œ ì‚¬ë§ìê°€ ê°€ì¥ ë§ì€ 3ê°œ êµ­ê°€ì™€ í•´ë‹¹ êµ­ê°€ì˜ ëˆ„ì  ì‚¬ë§ììˆ˜ë¥¼ ì¡°íšŒ
        
        **1 -** ëŒ€ë¥™ë³„/êµ­ê°€ë³„ group by
        
        ```sql
        select b.continent, b.countryname, sum(a.cases) case_num, sum(a.deaths) death_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         group by 1, 2
         order by 1;
        ```
        
        **2 -** ëŒ€ë¥™ë³„ ì‚¬ë§ìí•© ë‚´ë¦¼ ì°¨ìˆœ ì •ë ¬
        
        ```sql
        select b.continent, b.countryname, sum(a.cases) case_num, sum(a.deaths) death_num,
          rank() over (partition by b.continent order by sum(a.deaths) desc) ranks
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         group by 1, 2
         order by 1;
        ```
        
        **3 -** (1)+(2)ì— ranks <=3 ì¡°ê±´ ì¶”ê°€í•´ì„œ ìµœì¢…
        
        ```sql
        with tmp1 as(
        select b.continent, b.countryname, sum(a.cases) case_num, sum(a.deaths) death_num
          from covid19_data a
          inner join covid19_country b
            on a.countrycode = b.countrycode
         group by 1, 2
        ),
        tmp2 as(
        select continent, countryname, case_num, death_num,
          rank() over (partition by continent order by death_num desc) ranks
          from tmp1
        )
        select * from tmp2
         where ranks <= 3;
        ```
